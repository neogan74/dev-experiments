# tasks
- Install etcd locally
- Explore etcdctl commands (put, get, del)
- Understand key-value basics, prefixes, and ranges
- Experiment with TTLs and key expiration
- Try JSON vs binary values

## etcdctl basics

```bash
# Put a value
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 put demo/key "hello world"

# Get a value
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 get demo/key

# Delete a value
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 del demo/key
```

## Key-value, prefixes, and ranges

etcd stores keys as byte sequences sorted lexicographically. Organize related data with path-like keys so prefix queries stay efficient.

```bash
# Seed namespaced keys
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 put app/config/database postgres
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 put app/config/cache redis
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 put app/users/1001 '{"name":"Ada"}'
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 put app/users/1002 '{"name":"Lin"}'
```

### Prefix scans

```bash
# Fetch everything under app/config/
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 get app/config/ --prefix

# List only keys for users (no values)
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 get app/users/ --prefix --keys-only
```

### Lexicographic range reads

```bash
# Get keys in the half-open range [app/config/, app/config0)
# Note: "0" is just after "/" in ASCII, limiting the range.
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 get app/config/ app/config0

# Use ASCII successor helper to emulate prefix match without --prefix
succ=$(printf 'app/users/\x00')  # shell-escaped null byte marks the next possible key
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 get app/users/ "$succ"
```

### Cleaning up

```bash
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 del --prefix app/
```

## TTLs and key expiration

Leases attach time-to-live semantics to keys. When the lease expires, every key bound to it disappears automatically.

```bash
# Grant a 15-second lease and capture its ID
lease_id=$(docker compose exec etcd etcdctl --endpoints=http://localhost:2379 lease grant 15 | awk '/lease / {print $3}')

# Store a session token bound to the lease
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 put sessions/alice token-123 --lease="$lease_id"

# Inspect the lease metadata (remaning TTL, attached keys)
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 lease timetolive "$lease_id" --keys

# Read back the key before expiration
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 get sessions/alice
```

### Keep leases alive

```bash
# Open a keep-alive stream from the host (Ctrl+C to stop refreshing)
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 lease keep-alive "$lease_id"
```

### Manual expiration check

```bash
# Wait for the lease to expire naturally if keep-alive is not running
sleep 20
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 get sessions/alice
```

### Immediate revocation

```bash
# Force-remove keys by revoking the lease
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 lease revoke "$lease_id"

# Confirm the key is gone
docker compose exec etcd etcdctl --endpoints=http://localhost:2379 get sessions/alice
```
